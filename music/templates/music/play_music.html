{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'music/style.css' %}" />

<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{% block title %}Player{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/app.css' %}">
    {% block stylesheet %}{% endblock %}
  </head>
  <body>
    <header></header>
    <main>
      {{ user.username }} (<a href="/logout">Logout</a>)
      <table style="width:50%">
        <tr>
          <th></th>
          <th>Playlist</th>
        </tr>
        <tr>
            <td>
                <div 
                     id="player">
                </div>
            </td>
            <td class=op>
                {% if playlist_items %}
                    <ul style="text-align: center;">
                    {% for item in playlist_items %}
                        <li><a href="https://www.youtube.com/watch?v={{ item.youtube_id }}">{{ item.youtube_id }}</a></li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p style="text-align: center;">Playlist is empty :(</p>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td>
                <div>
                    <b>Config:</b>
                    <br />
                    <label>Shuffle: <input name="Shuffle" type="checkbox" , id="shuffle" onchange="pushConfig()"> </label>
                    <br />
                    <label>Repeat: <input name="Repeat" type="checkbox" , id="repeat" onchange="pushConfig()"> </label>
                </div>
            </td>
            <td>
                <label>URL: <input name="URL" type="text" , id="id_link"></label>
                <input type="button" value="Submit youtube link" onclick="submitYoutubeLink();" />
            </td>
        </tr>
      </table>

        <input type="button" value="Vote skip" onclick="voteSkip();"/>


    </main>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script src="{% static 'js/app.js' %}"></script>
    {% block javascript %}

    <script>
      ///////////////////////////////////
      // Database interaction
      ///////////////////////////////////

      // Debug stuff
      $("#id_link").change(function () {
        console.log( $(this).val() );
      });

      function voteSkip() {
        alert("Todo")
      }

      function submitYoutubeLink() {
          var link = $("#id_link").val();
          $.ajax({
              url: '{% url "add_youtube_url" %}',
              data: {
                'link': link
              },
              dataType: 'json',
              success: function (data) {
                  console.log(data);
                if (!data.success)
                {
                  alert("Failure!");
                }
                else
                {
                  alert(data.youtube_id + " added to playlist!");
                }
              }
          });
      }

      function pushConfig() {
          var sh = $("#shuffle").is(":checked");
          var re = $("#repeat").is(":checked");
          $.ajax({
              url: '{% url "change_config" %}',
              data: {
                    'shuffle': sh,
                    'repeat': re
              },
              dataType: 'json',
              success: function (data) {
                  alert("config has been changed");
              }
          });
      }

      // Add youtube url


    ///////////////////////////////////
    // Youtube player stuff
    ///////////////////////////////////
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '360',
          width: '640',
          videoId: 'M7lc1UVf-VE',
          playerVars: {'controls': 0 },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      function onPlayerReady(event) {
        event.target.playVideo();
      }

      var done = false;
      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !done) {
          setTimeout(stopVideo, 6000);
          done = true;
        }
      }
      function stopVideo() {
        player.stopVideo();
      }
    </script>

    {% endblock %}
  </body>
</html>

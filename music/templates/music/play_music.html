{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'music/style.css' %}" />

<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{% block title %}Player{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/app.css' %}">
    {% block stylesheet %}{% endblock %}
  </head>
  <body>
    <header></header>
    <main>
      {{ user.username }} (<a href="/logout">Logout</a>)
      <table style="width:50%">
        <tr>
          <th></th>
          <th><div id=PlaylistHeader></div></th>
        </tr>
        <tr>
            <td><div id="player"></div></td>
            <td class="op"><div style="overflow-y: scroll; height:360px ;" id="playlist"></div></td>
        </tr>

      </table>
      <table style="width:50%">
        <tr>
          <th><textarea id="interface_log" class="formbox" style="width:100%;height:250px;resize: none;}" readonly></textarea></th>
        </tr>
      </table>
      <table style="width:50%">
        <tr>
            <td>
                <div>
                    <b>Config:</b>
                    <label>Shuffle: <input name="Shuffle" type="checkbox" , id="shuffle" onchange="pushConfig()"> </label>
                    <label>Repeat: <input name="Repeat" type="checkbox" , id="repeat" onchange="pushConfig()"> </label>
                    <input type="button" value="Vote skip" onclick="voteSkip();"/>
                </div>
            </td>
            <td>
                <label>URL: <input name="URL" type="text" , id="id_link"></label>
                <input type="button" value="Submit youtube link" onclick="submitYoutubeLink();" />
            </td>
          </tr>
      </table>






    </main>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script src="{% static 'js/app.js' %}"></script>
    {% block javascript %}

    <script>
      ///////////////////////////////////
      // Database interaction
      ///////////////////////////////////

      // Debug stuff
      $("#id_link").change(function () {
        console.log( $(this).val() );
      });

      function voteSkip() {
          $.ajax({
              url: '{% url "vote_skip" %}',
              data: {},
              dataType: 'json',
              success: function (data) {
                  if (data.is_added) {
                      alert("You voted!");
                  }
                  else {
                      alert("Du hast schon gevotet!")
                  }
              }
          });
      }

      var interval = 1000;  // 1000 = 1 second, 3000 = 3 seconds
      function updateInterface() {
        $.ajax({
            url: '{% url "get_interface" %}',
            data: {},
            dataType: 'json',
            success: function (data) {
              console.log(data);

                //Update Interface
              $('#PlaylistHeader').text('Playlist ('+ data.playlist_length +')');
              $('#interface_log').text('Playlist ('+ data.playlist_length +')');
              $('#shuffle').prop("checked", data.shuffle);
              $('#repeat').prop("checked", data.repeat);

              var old_id = player.getVideoData()['video_id'];
              if (old_id != data.youtube_id)
              {
                player.loadVideoById(data.youtube_id);
              }

              if (data.is_playing) { //player.getPlayerState() == 2 &
                player.playVideo();
              } else if (!data.is_playing) {//player.getPlayerState() == 1 &
                player.pauseVideo();
              }

              //Update Playlist
              var node = document.getElementById("playlist");
              while (node.firstChild) {
                  node.removeChild(node.firstChild);
              }

              var playlist = data.playlist
              var list = document.createElement('ul');
              for(var i = 0; i < playlist.length; i++) {
                  var item = document.createElement('li');
                  item.appendChild(document.createTextNode(playlist[i]));
                  list.appendChild(item);
              }
              node.appendChild(list)
            },
            complete: function (data) {
                    setTimeout(updateInterface, interval);
            }
        });
      }


      function submitYoutubeLink() {
          var link = $("#id_link").val();
          $.ajax({
              url: '{% url "add_youtube_url" %}',
              data: {
                'link': link
              },
              dataType: 'json',
              success: function (data) {
                if (!data.success)
                {
                  alert("Failure!");
                }
              }
          });
      }

      function pushConfig() {
          var sh = $("#shuffle").is(":checked");
          var re = $("#repeat").is(":checked");
          $.ajax({
              url: '{% url "change_config" %}',
              data: {
                    'shuffle': sh,
                    'repeat': re
              },
              dataType: 'json',
              success: function (data) {}
          });
      }

      // Add youtube url


    ///////////////////////////////////
    // Youtube player stuff
    ///////////////////////////////////
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '360',
          width: '640',
          videoId: 'UBX8MWYel3s',
          playerVars: {'controls': 1 },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange,
          }
        });
      }

      function onPlayerReady(event) {
        event.target.playVideo();
        setTimeout(updateInterface, 100);
      }

      function onPlayerStateChange(event) {
          $.ajax({
              url: '{% url "notify_server" %}',
              data: {
                  'status': event.data
              },
              dataType: 'json',
              success: function (data) {
                  console.log(data);
              }
          });
      }

      function stopVideo() {
        player.stopVideo();
      }
    </script>

    {% endblock %}
  </body>
</html>
